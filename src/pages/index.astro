---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';

// Fetch all blog posts, sort by date descending
const posts = (await getCollection('blog', ({ id, data }) => {
	const idLower = id.toLowerCase();
	const isInPrivateFolder = idLower.includes('/private/') || idLower.startsWith('private/');
	const isPrivatePost = data.private === true;
	return !(isInPrivateFolder || isPrivatePost);
}))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by category
const postsByCategory = posts.reduce((acc, post) => {
  const category = post.data.category || 'uncategorized';
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(post);
  return acc;
}, {});

// Add downloads category for Handy+ and Music
if (!postsByCategory['downloads']) {
  postsByCategory['downloads'] = [];
}
postsByCategory['downloads'].push({
  id: 'handy-plus',
  data: {
    title: 'Handy+',
    pubDate: new Date('2014-02-19'),
    category: 'downloads'
  },
  isArchived: true
});
postsByCategory['downloads'].push({
  id: 'music',
  data: {
    title: 'music',
    pubDate: new Date(),
    category: 'downloads'
  },
  isArchived: false
});
// postsByCategory['downloads'].push({
//   id: 'tweets',
//   data: {
//     title: 'tweets',
//     pubDate: new Date(),
//     category: 'downloads'
//   },
//   isArchived: false
// });

// Sort categories alphabetically
const sortedCategories = Object.keys(postsByCategory).sort();

---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="literature2">
		<div class="layout-wrapper">
			<aside class="sidebar">
				<Header />
			</aside>
			<div class="main-content-area">
				<main>
					<h1>Index</h1>
					<hr />

					{sortedCategories.map((category) => {
						const categoryPosts = postsByCategory[category];
						return (
							<div class="category-section">
								<h2>{category}</h2>
								<ul>
									{categoryPosts.map((post) => (
										<li>
											<a href={post.isArchived ? `/${post.id}.html` : `/${post.id}/`}>{post.data.title}</a>
										</li>
									))}
								</ul>
							</div>
						);
					})}
				</main>
				<Footer />
				<style>
					h1 {
						font-size: 1.5em;
						margin: 0 0 0.5em 0;
					}

					hr {
						border: none;
						border-top: 1px solid #000;
						margin: 0.5em 0 1.5em 0;
					}

					.category-section {
						margin-bottom: 1.5em;
					}

					.category-section h2 {
						font-size: 1.1em;
						font-weight: 600;
						margin: 0 0 0.3em 0;
					}

					.category-section ul {
						list-style: none;
						padding: 0;
						margin: 0;
					}

					.category-section li {
						margin: 0.2em 0;
						padding-left: 1em;
					}

					.category-section a {
						color: var(--color-link);
						text-decoration: underline;
					}

					.category-section a:hover {
						text-decoration: none;
					}
				</style>
			</div>
			<aside class="sidenotes-area">
				{/* Sidenotes will go here on relevant pages */}
			</aside>
		</div>
	</body>
</html>
