---
import Layout from '../layouts/BlogPost.astro';

// Manual track list with external URLs
// All files hosted on Catbox - no local file system scanning
const tracks = [
	{
		name: 'Be My Glock.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/tia4sx.mp3',
		size: '8.4mb',
		modified: '12.11.25 10:29'
	},
	{
		name: 'Bel Air Hotel.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/as08h7.mp3',
		size: '8.8mb',
		modified: '12.11.25 10:32'
	},
	{
		name: 'Cant.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/qnr67h.mp3',
		size: '8.45mb',
		modified: '12.11.25 15:30'
	},
	{
		name: "c'est la vie.mp3",
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/v99y5h.mp3',
		size: '4.6mb',
		modified: '5.7.24 22:40'
	},
	{
		name: "D'angelo - Inst. #5 (rare).mp3",
		artist: "D'Angelo",
		url: 'https://files.catbox.moe/3jy7bb.mp3',
		size: '7.2mb',
		modified: '26.10.24 18:04'
	},
	{
		name: 'Danny Scissorhands.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/shirg1.mp3',
		size: '~8mb',
		modified: '12.11.25 16:00'
	},
	{
		name: 'DNA.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/an2j6r.mp3',
		size: '6.0mb',
		modified: '13.3.25 00:00'
	},
	{
		name: 'Easy.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/82k6va.mp3',
		size: '5.0mb',
		modified: '2.7.24 23:44'
	},
	{
		name: 'Finger.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/9ov7nc.mp3',
		size: '5.5mb',
		modified: '12.11.25 10:35'
	},
	{
		name: 'fly you out (2020).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/o3n3cd.mp3',
		size: '5.7mb',
		modified: '3.7.24 03:29'
	},
	{
		name: 'Girls Lie Too.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/nw677u.mp3',
		size: '4.0mb',
		modified: '12.11.25 10:24'
	},
	{
		name: 'Its Not Your Fault (2022).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/g1g6ud.mp3',
		size: '9.0mb',
		modified: '12.11.25 10:37'
	},
	{
		name: 'Jealousy.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/2vhi4p.mp3',
		size: '5.5mb',
		modified: '5.9.24 00:00'
	},
	{
		name: 'Me And You (ROUGH).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/nah41b.mp3',
		size: '2.1mb',
		modified: '12.11.25 10:30'
	},
	{
		name: 'On My Own.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/it86km.mp3',
		size: '9.9mb',
		modified: '12.11.25 10:25'
	},
	{
		name: 'Pestilence.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/vxz22l.mp3',
		size: '6.1mb',
		modified: '12.11.25 10:42'
	},
	{
		name: 'PIGALLE.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/im2xps.mp3',
		size: '11mb',
		modified: '12.11.25 10:28'
	},
	{
		name: 'Shame.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/h0yv4u.mp3',
		size: '~8mb',
		modified: '12.11.25 15:45'
	},
	{
		name: 'Sneaking Around (2024).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/z8kys1.mp3',
		size: '7.8mb',
		modified: '12.11.25 11:38'
	},
	{
		name: 'SUPERPOWERS.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/bqh1yg.mp3',
		size: '7.2mb',
		modified: '12.11.25 10:27'
	},
	{
		name: 'TILL THE DAY (ft. Sampha).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/2kzc78.mp3',
		size: '12mb',
		modified: '12.11.25 10:25'
	}
];

// Sort alphabetically
tracks.sort((a, b) => a.name.localeCompare(b.name));
---

<Layout
	title="Music Downloads"
	description="Free MP3 downloads and unreleased tracks"
	pubDate={new Date()}
	pageType="literature"
>
	<div class="directory-listing">
		<h1>Index of /music</h1>

		<table>
			<thead>
				<tr>
					<th class="col-play"></th>
					<th class="col-name">Name</th>
					<th class="col-artist">Artist</th>
					<th class="col-modified">Last modified</th>
					<th class="col-size">Size</th>
				</tr>
			</thead>
			<tbody>
				<tr class="parent">
					<td class="col-play"></td>
					<td class="col-name"><a href="/">..</a></td>
					<td class="col-artist">-</td>
					<td class="col-modified">-</td>
					<td class="col-size">-</td>
				</tr>
				{tracks.map(track => (
					<tr class="file" data-audio-src={track.url}>
						<td class="col-play">
							<button class="play-btn" aria-label={`Play ${track.name}`}>▶</button>
						</td>
						<td class="col-name">
							{track.name}
						</td>
						<td class="col-artist">{track.artist}</td>
						<td class="col-modified">{track.modified}</td>
						<td class="col-size">
							<a href={`/download-proxy/?url=${encodeURIComponent(track.url)}&filename=${encodeURIComponent(track.name)}`} class="size-link" download={track.name}>{track.size}</a>
						</td>
					</tr>
				))}
			</tbody>
		</table>

		<audio id="audio-player" preload="metadata"></audio>
	</div>

	<style>
		.directory-listing {
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
			font-size: 12px;
			line-height: 1.4;
			max-width: 100%;
		}

		h1 {
			font-size: 14px;
			font-weight: 400;
			margin: 0 0 8px 0;
			color: #1d1d1f;
			letter-spacing: 0;
			cursor: default;
			pointer-events: none;
		}

		hr {
			border: none;
			border-top: 1px solid #1d1d1f;
			margin: 8px 0 12px 0;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin: 0;
		}

		thead th {
			text-align: left;
			font-weight: 400;
			padding: 4px 12px 4px 0;
			color: #1d1d1f;
			border-bottom: 1px solid #1d1d1f;
			font-size: 11px;
			letter-spacing: 0;
		}

		thead th.col-play {
			width: 18px;
			padding: 0;
			border: none;
		}

		tbody td {
			padding: 5px 12px 5px 0;
			color: #1d1d1f;
			border-bottom: 1px solid #e5e5e5;
			font-size: 12px;
		}

		tbody td.col-play {
			width: 18px;
			padding: 0 8px 0 0;
			border: none;
			background: none !important;
		}

		tbody tr:last-child td {
			border-bottom: none;
		}

		.col-name {
			width: 38%;
		}

		.col-artist {
			width: 18%;
			white-space: nowrap;
			padding-right: 25px !important;
		}

		.col-modified {
			width: 22%;
			white-space: nowrap;
		}

		.col-size {
			width: 12%;
			text-align: right;
		}

		.size-link {
			color: #0066CC;
			text-decoration: none;
			border-bottom: 1px solid transparent;
			transition: all 0.2s ease;
		}

		.size-link:hover {
			border-bottom-color: #0066CC;
			opacity: 0.8;
		}

		.play-btn {
			background: none;
			border: none;
			color: #1d1d1f;
			font-size: 9px;
			cursor: pointer;
			padding: 0;
			margin: 0;
			width: 10px;
			height: auto;
			line-height: 1;
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
			text-align: left;
			display: inline-block;
			position: relative;
		}

		.play-btn:hover {
			opacity: 0.6;
		}

		.play-btn:focus {
			outline: none;
		}

		.playing .play-btn {
			left: -1px;
		}

		#audio-player {
			display: none;
		}

		a {
			color: #1d1d1f;
			text-decoration: none;
			border-bottom: 1px solid transparent;
			transition: border-bottom-color 0.15s ease;
		}

		a:hover {
			border-bottom-color: #1d1d1f;
		}

		.parent a {
			font-weight: 600;
		}

		.parent td {
			text-align: center;
		}

		.parent .col-name {
			text-align: left;
		}

		.preview-section {
			margin-top: 30px;
		}

		.audio-preview {
			width: 100%;
			max-width: 600px;
			height: 32px;
		}

		/* Mobile responsive */
		@media (max-width: 1000px) {
			h1 {
				font-size: 13px;
			}

			thead th.col-play,
			thead th.col-artist,
			thead th.col-modified,
			thead th.col-size {
				display: none;
			}

			tbody td.col-play {
				padding-right: 6px;
			}

			tbody td.col-artist,
			tbody td.col-modified,
			tbody td.col-size {
				display: none;
			}

			.col-name {
				width: 100%;
			}

			.play-btn {
				font-size: 8px;
			}

			.playing .play-btn {
				left: -1px;
			}
		}
	</style>

	<script>
		const audioPlayer = document.getElementById('audio-player');
		const playButtons = document.querySelectorAll('.play-btn');
		let currentRow = null;
		let currentButton = null;

		playButtons.forEach(button => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				const row = button.closest('tr');
				const audioSrc = row.getAttribute('data-audio-src');

				if (!audioSrc) return;

				// If clicking the currently playing track
				if (currentRow === row) {
					if (audioPlayer.paused) {
						audioPlayer.play();
						button.textContent = '❚❚';
						row.classList.add('playing');
					} else {
						audioPlayer.pause();
						button.textContent = '▶';
						row.classList.remove('playing');
					}
				} else {
					// Stop current track and play new one
					if (currentButton) {
						currentButton.textContent = '▶';
						currentRow?.classList.remove('playing');
					}

					audioPlayer.src = audioSrc;
					audioPlayer.play();
					button.textContent = '❚❚';
					row.classList.add('playing');

					currentRow = row;
					currentButton = button;
				}
			});
		});

		// Reset button when audio ends
		audioPlayer.addEventListener('ended', () => {
			if (currentButton) {
				currentButton.textContent = '▶';
				currentRow?.classList.remove('playing');
			}
		});

		// Update button state when audio is paused externally
		audioPlayer.addEventListener('pause', () => {
			if (currentButton && !audioPlayer.ended) {
				currentButton.textContent = '▶';
				currentRow?.classList.remove('playing');
			}
		});

		// Update button state when audio plays
		audioPlayer.addEventListener('play', () => {
			if (currentButton) {
				currentButton.textContent = '❚❚';
				currentRow?.classList.add('playing');
			}
		});

		// Register service worker for download proxy
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/download-sw.js')
				.then(registration => {
					console.log('[Download SW] Registered:', registration);

					// If service worker is installing for first time
					if (registration.installing) {
						console.log('[Download SW] Installing... Downloads will work after refresh.');
					}

					// Wait for service worker to be ready
					navigator.serviceWorker.ready.then(() => {
						console.log('[Download SW] Ready! Downloads will stream instantly.');
					});
				})
				.catch(error => {
					console.error('[Download SW] Registration failed:', error);
				});
		}
	</script>
</Layout>
