---
import Layout from '../layouts/BlogPost.astro';

// Manual track list with external URLs
// All files hosted on Catbox - no local file system scanning
const tracks = [
	// {
	// 	name: 'Be My Glock.mp3',
	// 	artist: 'Daniel Caesar',
	// 	url: 'https://files.catbox.moe/tia4sx.mp3',
	// 	size: '8.4mb',
	// 	modified: '12.11.25 10:29'
	// },
	{
		name: 'Bel Air Hotel.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/as08h7.mp3',
		size: '8.8mb',
		modified: '12.11.25 10:32'
	},
	{
		name: "Can't.mp3",
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/qnr67h.mp3',
		size: '8.45mb',
		modified: '12.11.25 15:30'
	},
	{
		name: "C'est La Vie.mp3",
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/v99y5h.mp3',
		size: '4.6mb',
		modified: '5.7.24 22:40'
	},
	// {
	// 	name: "D'angelo - Inst. #5 (rare).mp3",
	// 	artist: "D'Angelo",
	// 	url: 'https://files.catbox.moe/3jy7bb.mp3',
	// 	size: '7.2mb',
	// 	modified: '26.10.24 18:04'
	// },
	{
		name: 'Danny Scissorhands.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/shirg1.mp3',
		size: '~8mb',
		modified: '12.11.25 16:00'
	},
	{
		name: 'DNA.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/an2j6r.mp3',
		size: '6mb',
		modified: '13.3.25 00:00'
	},
	{
		name: 'Easy.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/82k6va.mp3',
		size: '5mb',
		modified: '2.7.24 23:44'
	},
	{
		name: 'Finger.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/9ov7nc.mp3',
		size: '5.5mb',
		modified: '12.11.25 10:35'
	},
	{
		name: 'Fly You Out.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/o3n3cd.mp3',
		size: '5.7mb',
		modified: '3.7.24 03:29'
	},
	{
		name: 'Girls Lie Too.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/nw677u.mp3',
		size: '4mb',
		modified: '12.11.25 10:24'
	},
	{
		name: 'Its Not Your Fault (2022).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/g1g6ud.mp3',
		size: '9mb',
		modified: '12.11.25 10:37'
	},
	{
		name: 'Jealousy.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/2vhi4p.mp3',
		size: '5.5mb',
		modified: '5.9.24 00:00'
	},
	// {
	// 	name: 'Me And You (ROUGH).mp3',
	// 	artist: 'Daniel Caesar',
	// 	url: 'https://files.catbox.moe/nah41b.mp3',
	// 	size: '2.1mb',
	// 	modified: '12.11.25 10:30'
	// },
	{
		name: 'On My Own.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/it86km.mp3',
		size: '9.9mb',
		modified: '12.11.25 10:25'
	},
	{
		name: 'Pestilence.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/vxz22l.mp3',
		size: '6.1mb',
		modified: '12.11.25 10:42'
	},
	// {
	// 	name: 'PIGALLE.mp3',
	// 	artist: 'Daniel Caesar',
	// 	url: 'https://files.catbox.moe/im2xps.mp3',
	// 	size: '11mb',
	// 	modified: '12.11.25 10:28'
	// },
	{
		name: 'Shame.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/h0yv4u.mp3',
		size: '~8mb',
		modified: '12.11.25 15:45'
	},
	{
		name: 'Sneaking Around.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/z8kys1.mp3',
		size: '7.8mb',
		modified: '12.11.25 11:38'
	},
	// {
	// 	name: 'SUPERPOWERS.mp3',
	// 	artist: 'Daniel Caesar',
	// 	url: 'https://files.catbox.moe/bqh1yg.mp3',
	// 	size: '7.2mb',
	// 	modified: '12.11.25 10:27'
	// },
	{
		name: 'Till The Day (ft. Sampha).mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/2kzc78.mp3',
		size: '12mb',
		modified: '12.11.25 10:25'
	},
	{
		name: 'Casanova Complex.m4a',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/omimd5.m4a',
		size: '2.24mb',
		modified: '18.11.25 00:00'
	},
	{
		name: 'If Only A Friend (live).mp3',
		artist: 'Sampha',
		url: 'https://files.catbox.moe/rt57xn.mp3',
		size: '1.98mb',
		modified: '18.11.25 00:00'
	},
	// {
	// 	name: "Wasn't There.mp3",
	// 	artist: 'Anna Wise',
	// 	url: 'https://files.catbox.moe/aixl4a.mp3',
	// 	size: '1.18mb',
	// 	modified: '18.11.25 00:00'
	// },
	{
		name: 'Root_of_all_Evil_live.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/1xw24j.mp3',
		size: '12.3mb',
		modified: '18.11.25 00:00'
	},
	{
		name: 'Master Yourself.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/viiywc.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'New Life.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/yhnp0u.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Post Modernity.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/zevuup.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'PROJECTING ME.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/b3t2kb.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Indecision.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/rfepvw.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'For Once In My Life.mp3',
		artist: 'Monica Martin, James Blake',
		url: 'https://files.catbox.moe/kclwal.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'peter-collins-1.mp3',
		artist: 'Peter Collins',
		url: '/music/peter-collins-1.mp3',
		size: '0.5mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Midnight in Majorca.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/dd2se0.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Pussy.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/sqr5yb.mp3',
		size: '?mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Sweet Emily (live).m4a',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/41bgv2.m4a',
		size: '5.3mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Dope.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/olc4j8.MP3',
		size: '2mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Sweet.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/zobts5.mp3',
		size: '8.9mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Salvation On Mt. Olympus.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/akw2x2.mp3',
		size: '11.2mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'Eye Of Mine.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/wdeeby.mp3',
		size: '4.1mb',
		modified: '25.1.26 00:00'
	},
	{
		name: 'YoBro.mp3',
		artist: 'Daniel Caesar',
		url: 'https://files.catbox.moe/mfe88g.mp3',
		size: '10.4mb',
		modified: '25.1.26 00:00'
	}
];

// Sort alphabetically
tracks.sort((a, b) => a.name.localeCompare(b.name));
---

<Layout
	title="ely0030 | Music"
	description="Free MP3 downloads and unreleased tracks"
	pubDate={new Date()}
	pageType="literature"
	heroImage="/music-banner.jpg"
>
	<div class="directory-listing">
		<h1><a href="/">Index</a> of /music</h1>

		<table>
			<thead>
				<tr>
					<th class="col-play"></th>
					<th class="col-name">Name</th>
					<th class="col-modified">Last modified</th>
					<th class="col-duration">Duration</th>
					<th class="col-size">Size</th>
				</tr>
			</thead>
			<tbody>
				<tr class="parent">
					<td class="col-play">
						<button class="shuffle-btn" aria-label="Toggle shuffle mode">⤨</button>
					</td>
					<td class="col-name"><a href="/">..</a></td>
					<td class="col-modified">-</td>
					<td class="col-duration">-</td>
					<td class="col-size">-</td>
				</tr>
				{tracks.map(track => (
					<tr class="file" data-audio-src={track.url}>
						<td class="col-play">
							<button class="play-btn" aria-label={`Play ${track.name}`}>▶</button>
						</td>
						<td class="col-name">
							<span class="track-name">{track.name}</span>
							<span class="track-artist">{track.artist}</span>
						</td>
						<td class="col-modified">{track.modified}</td>
						<td class="col-duration">-</td>
						<td class="col-size">
							<a href={`/download-proxy/?url=${encodeURIComponent(track.url)}&filename=${encodeURIComponent(track.name)}`} class="size-link" download={track.name}>{track.size}</a>
						</td>
					</tr>
				))}
			</tbody>
		</table>

		<audio id="audio-player" preload="metadata"></audio>
	</div>

	<style>
		.directory-listing {
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
			font-size: 12px;
			line-height: 1.4;
			max-width: 100%;
		}

		h1 {
			font-size: 14px;
			font-weight: 400;
			margin: 0 0 8px 0;
			color: #1d1d1f;
			letter-spacing: 0;
			cursor: default !important;
		}

		h1 a,
		h1 a:hover,
		h1 a:visited,
		h1 a:active,
		h1 a:focus {
			color: #1d1d1f !important;
			text-decoration: none !important;
			border: none !important;
			border-bottom: none !important;
			background: none !important;
			box-shadow: none !important;
			cursor: pointer !important;
			outline: none !important;
		}

		hr {
			border: none;
			border-top: 1px solid #1d1d1f;
			margin: 8px 0 12px 0;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin: 0;
		}

		thead th {
			text-align: left;
			font-weight: 400;
			padding: 4px 12px 4px 0;
			color: #1d1d1f;
			border-bottom: 1px solid #1d1d1f;
			font-size: 11px;
			letter-spacing: 0;
		}

		thead th.col-play {
			width: 18px;
			padding: 0;
			border: none;
		}

		tbody td {
			padding: 5px 12px 5px 0;
			color: #1d1d1f;
			border-bottom: 1px solid #e5e5e5;
			font-size: 12px;
		}

		tbody td.col-play {
			width: 18px;
			padding: 0 8px 0 0;
			border: none;
			background: none !important;
		}

		tbody tr:last-child td {
			border-bottom: none;
		}

		.col-name {
			width: 50%;
		}

		.track-name {
			display: block;
		}

		.track-artist {
			display: block;
			font-size: 10px;
			color: #666;
			margin-top: 2px;
		}

		.col-modified,
		th.col-modified {
			display: none; /* Hidden for now */
		}

		.col-duration,
		thead th.col-duration {
			width: 12%;
			white-space: nowrap;
			text-align: center;
			padding-right: 40px !important;
		}

		.col-size,
		thead th.col-size {
			width: 10%;
			text-align: center;
		}

		.size-link {
			color: #0066CC;
			text-decoration: none;
			border-bottom: 1px solid transparent;
			transition: all 0.2s ease;
		}

		.size-link:hover {
			border-bottom-color: #0066CC;
			opacity: 0.8;
		}

		.play-btn {
			background: none;
			border: none;
			color: #1d1d1f;
			font-size: 9px;
			cursor: pointer;
			padding: 0;
			margin: 0;
			width: 10px;
			height: auto;
			line-height: 1;
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
			text-align: left;
			display: inline-block;
			position: relative;
		}

		.play-btn:hover {
			opacity: 0.6;
		}

		.play-btn:focus {
			outline: none;
		}

		.playing .play-btn {
			left: -1px;
		}

		.shuffle-btn {
			background: none;
			border: none;
			color: #1d1d1f;
			font-size: 9px;
			cursor: pointer;
			padding: 0;
			margin: 0;
			width: 10px;
			height: auto;
			line-height: 1;
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
			text-align: left;
			display: inline-block;
			position: relative;
			left: -2px;
			opacity: 0;
			transition: opacity 0.2s ease;
		}

		/* Show on desktop hover */
		@media (min-width: 1001px) {
			.parent:hover .shuffle-btn {
				opacity: 1;
			}

			/* Always show when shuffle is active */
			.shuffle-btn.active {
				opacity: 1;
			}
		}

		/* Always show on mobile */
		@media (max-width: 1000px) {
			.shuffle-btn {
				opacity: 1;
			}
		}

		.shuffle-btn:hover {
			opacity: 0.6 !important;
		}

		.shuffle-btn:focus {
			outline: none;
		}

		.shuffle-btn.active {
			color: #0066CC;
		}

		#audio-player {
			display: none;
		}

		a {
			color: #1d1d1f;
			text-decoration: none;
			border-bottom: 1px solid transparent;
			transition: border-bottom-color 0.15s ease;
		}

		a:hover {
			border-bottom-color: #1d1d1f;
		}

		.parent a {
			font-weight: 600;
		}

		.parent td {
			text-align: center;
		}

		.parent .col-name {
			text-align: left;
		}

		.preview-section {
			margin-top: 30px;
		}

		.audio-preview {
			width: 100%;
			max-width: 600px;
			height: 32px;
		}

		/* Mobile responsive */
		@media (max-width: 1000px) {
			h1 {
				font-size: 13px;
			}

			thead th.col-modified,
			thead th.col-duration {
				display: none;
			}

			tbody td.col-play {
				padding-right: 8px;
				width: 20px;
			}

			tbody td.col-modified,
			tbody td.col-duration {
				display: none;
			}

			.col-name {
				width: 65%;
				padding-right: 8px;
			}

			.col-size {
				width: 25%;
			}

			.play-btn {
				font-size: 9px;
				width: 12px;
			}

			.playing .play-btn {
				left: -1px;
			}

			.shuffle-btn {
				font-size: 9px;
				width: 12px;
				left: -2px;
			}
		}
	</style>

	<script>
		const audioPlayer = document.getElementById('audio-player');
		const playButtons = document.querySelectorAll('.play-btn');
		const shuffleBtn = document.querySelector('.shuffle-btn');
		let currentRow = null;
		let currentButton = null;
		let shuffleMode = false;
		let playedTracks = new Set();

		// Get all track rows (excluding parent row)
		const getAllTrackRows = () => {
			return Array.from(document.querySelectorAll('tr.file[data-audio-src]'));
		};

		// Get a random unplayed track
		const getRandomUnplayedTrack = () => {
			const allRows = getAllTrackRows();
			const unplayedRows = allRows.filter(row => {
				const audioSrc = row.getAttribute('data-audio-src');
				return !playedTracks.has(audioSrc);
			});

			// If all tracks have been played, reset the played set
			if (unplayedRows.length === 0) {
				playedTracks.clear();
				console.log('[Shuffle] All tracks played, resetting...');
				return allRows[Math.floor(Math.random() * allRows.length)];
			}

			return unplayedRows[Math.floor(Math.random() * unplayedRows.length)];
		};

		// Play a specific row
		const playRow = (row) => {
			if (!row) return;

			const audioSrc = row.getAttribute('data-audio-src');
			const button = row.querySelector('.play-btn');

			if (!audioSrc || !button) return;

			// Stop current track
			if (currentButton) {
				currentButton.textContent = '▶';
				currentRow?.classList.remove('playing');
			}

			// Play new track
			audioPlayer.src = audioSrc;
			audioPlayer.play();
			button.textContent = '❚❚';
			row.classList.add('playing');

			currentRow = row;
			currentButton = button;

			// Track this song as played
			playedTracks.add(audioSrc);
		};

		// Toggle shuffle mode
		shuffleBtn.addEventListener('click', (e) => {
			e.preventDefault();
			shuffleMode = !shuffleMode;

			if (shuffleMode) {
				shuffleBtn.classList.add('active');
				console.log('[Shuffle] Shuffle mode ON');
			} else {
				shuffleBtn.classList.remove('active');
				console.log('[Shuffle] Shuffle mode OFF');
			}
		});

		playButtons.forEach(button => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				const row = button.closest('tr');
				const audioSrc = row.getAttribute('data-audio-src');

				if (!audioSrc) return;

				// If clicking the currently playing track
				if (currentRow === row) {
					if (audioPlayer.paused) {
						audioPlayer.play();
						button.textContent = '❚❚';
						row.classList.add('playing');
					} else {
						audioPlayer.pause();
						button.textContent = '▶';
						row.classList.remove('playing');
					}
				} else {
					// Stop current track and play new one
					if (currentButton) {
						currentButton.textContent = '▶';
						currentRow?.classList.remove('playing');
					}

					audioPlayer.src = audioSrc;
					audioPlayer.play();
					button.textContent = '❚❚';
					row.classList.add('playing');

					currentRow = row;
					currentButton = button;

					// Track this song as played
					playedTracks.add(audioSrc);
				}
			});
		});

		// When audio ends, play next random song if shuffle is on
		audioPlayer.addEventListener('ended', () => {
			if (currentButton) {
				currentButton.textContent = '▶';
				currentRow?.classList.remove('playing');
			}

			// If shuffle mode is on, play next random unplayed track
			if (shuffleMode) {
				const nextRow = getRandomUnplayedTrack();
				if (nextRow) {
					console.log('[Shuffle] Auto-playing next random track...');
					playRow(nextRow);
				}
			}
		});

		// Update button state when audio is paused externally
		audioPlayer.addEventListener('pause', () => {
			if (currentButton && !audioPlayer.ended) {
				currentButton.textContent = '▶';
				currentRow?.classList.remove('playing');
			}
		});

		// Update button state when audio plays
		audioPlayer.addEventListener('play', () => {
			if (currentButton) {
				currentButton.textContent = '❚❚';
				currentRow?.classList.add('playing');
			}
		});

		const downloadLinks = document.querySelectorAll('.size-link');

		// Use the same download flow on all devices:
		// 1) Try service worker-powered proxy for direct downloads
		// 2) Fall back to direct Catbox links if SW isn't available or fails
		if ('serviceWorker' in navigator) {
			// Disable download links until SW is ready
			downloadLinks.forEach(link => {
				link.style.opacity = '0.5';
				link.style.pointerEvents = 'none';
				link.title = 'Preparing downloads...';
			});

			navigator.serviceWorker.register('/download-sw.js')
				.then(registration => {
					console.log('[Download SW] Registered:', registration);
					return navigator.serviceWorker.ready;
				})
				.then(() => {
					console.log('[Download SW] Ready! Downloads enabled.');
					downloadLinks.forEach(link => {
						link.style.opacity = '1';
						link.style.pointerEvents = 'auto';
						link.title = 'Download';
					});
				})
				.catch(error => {
					console.error('[Download SW] Registration failed:', error);
					console.log('[Download SW] Falling back to direct downloads');

					// Fallback: change links to direct Catbox URLs
					downloadLinks.forEach(link => {
						const url = new URL(link.href);
						const fileUrl = url.searchParams.get('url');
						if (fileUrl) {
							link.href = fileUrl;
							link.target = '_blank';
						}
						link.style.opacity = '1';
						link.style.pointerEvents = 'auto';
						link.title = 'Download (opens in new tab)';
					});
				});
		} else {
			// No service worker support - use direct links
			console.log('[Download SW] Service workers not supported');
			downloadLinks.forEach(link => {
				const url = new URL(link.href);
				const fileUrl = url.searchParams.get('url');
				if (fileUrl) {
					link.href = fileUrl;
					link.target = '_blank';
				}
				link.title = 'Download (opens in new tab)';
			});
		}

		// Fix h1 cursor and link behavior (override BlogPost layout JS)
		setTimeout(() => {
			const h1 = document.querySelector('.directory-listing h1');
			if (h1) h1.style.cursor = 'default';

			// Make the Index link work by stopping propagation
			const h1Link = document.querySelector('.directory-listing h1 a');
			if (h1Link) {
				h1Link.addEventListener('click', (e) => {
					e.stopPropagation();
				});
			}
		}, 0);

		// Fetch durations for all tracks
		const formatDuration = (seconds) => {
			const mins = Math.floor(seconds / 60);
			const secs = Math.floor(seconds % 60);
			return `${mins}:${secs.toString().padStart(2, '0')}`;
		};

		document.querySelectorAll('tr.file').forEach(row => {
			const audioSrc = row.getAttribute('data-audio-src');
			const durationCell = row.querySelector('.col-duration');
			if (audioSrc && durationCell) {
				const audio = new Audio();
				audio.preload = 'metadata';
				audio.addEventListener('loadedmetadata', () => {
					durationCell.textContent = formatDuration(audio.duration);
				});
				audio.addEventListener('error', () => {
					durationCell.textContent = '-';
				});
				audio.src = audioSrc;
			}
		});
	</script>
</Layout>
