---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import StyleEditor from '../components/StyleEditor.astro';
import { type MarkdownHeading } from 'astro';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage, tags, pageType = 'blog', pageLayout, strictSpacing, immersive } = Astro.props;

// Determine the actual page type being used
const displayPageType = pageLayout === 'book' ? 'book' : pageType;

const headings = Astro.locals.headings ?? [];

function buildToc(headings: MarkdownHeading[]) {
	const toc: any[] = [];
	const parentHeadings = new Map();
	headings.forEach((h) => {
		const heading = { ...h, subheadings: [] };
		parentHeadings.set(heading.depth, heading);
		if (heading.depth === 2) {
			toc.push(heading);
		} else {
			const parent = parentHeadings.get(heading.depth - 1);
			if (parent) {
				parent.subheadings.push(heading);
			}
		}
	});
	return toc;
}

const toc = buildToc(headings);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style is:global>
			/* Page type indicator styles */
			.page-type-indicator {
				display: inline-block;
				font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
				font-size: 0.75rem;
				padding: 0.25rem 0.5rem;
				background: rgba(0, 0, 0, 0.05);
				border: 1px solid rgba(0, 0, 0, 0.1);
				border-radius: 3px;
				color: rgba(0, 0, 0, 0.6);
				margin-bottom: 1.5rem;
				letter-spacing: 0.02em;
			}
			
			/* Dark mode support */
			@media (prefers-color-scheme: dark) {
				.page-type-indicator {
					background: rgba(255, 255, 255, 0.05);
					border-color: rgba(255, 255, 255, 0.1);
					color: rgba(255, 255, 255, 0.6);
				}
			}
			
			/* Page type specific colors */
			.page-type-indicator.type-magazine {
				background: rgba(255, 107, 107, 0.1);
				border-color: rgba(255, 107, 107, 0.3);
				color: rgba(255, 107, 107, 0.9);
			}
			
			.page-type-indicator.type-stanza {
				background: rgba(155, 89, 182, 0.1);
				border-color: rgba(155, 89, 182, 0.3);
				color: rgba(155, 89, 182, 0.9);
			}
			
			.page-type-indicator.type-literature,
			.page-type-indicator.type-literature2,
			.page-type-indicator.type-literature3 {
				background: rgba(52, 152, 219, 0.1);
				border-color: rgba(52, 152, 219, 0.3);
				color: rgba(52, 152, 219, 0.9);
			}
			
			.page-type-indicator.type-book {
				background: rgba(139, 69, 19, 0.1);
				border-color: rgba(139, 69, 19, 0.3);
				color: rgba(139, 69, 19, 0.9);
			}
			
			/* Remove main width override */
			/* main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			} */
			.post-header {
				margin-bottom: 2em;
			}
			.post-title {
				font-size: 2.5em; /* Match h1 */
				margin: 0 0 0.25em 0;
				line-height: 1.1;
				/* color: rgb(var(--title-color)); -- Removed, use default text color */
			}
			.post-meta {
				font-size: 0.9em;
				color: rgb(var(--subtle-gray)); /* Use subtle gray */
			}
			.tags-list {
				list-style: none;
				padding: 0;
				margin: 0.5em 0 0 0;
				color: rgb(var(--subtle-gray)); /* Use subtle gray for "tags:" */
			}
			.tags-list li {
				display: inline-block;
				margin-right: 0.5em;
			}
			
			/* Fix spacing between paragraphs and lists */
			body.literature2 .prose p + ul,
			body.literature2 .prose p + ol {
				margin-top: 0.5em !important;
			}
			.tags-list a {
				color: rgb(var(--link-color)); /* Use purple for tag links */
				text-decoration: underline;
				font-size: 0.9em;
			}
			.tags-list a:hover {
				color: rgb(var(--link-color)); /* Keep purple on hover */
				text-decoration: none;
			}
			.hero-image {
				width: 100%;
				margin-bottom: 2em; /* Add space below image */
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				/* border-radius: 8px; */ /* Removed border-radius */
				box-shadow: none; /* Remove shadow for flatter look */
			}
			/* Remove .prose width/padding/color styles */
			/* .prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: rgb(var(--gray-dark));
			} */
			.prose {
				/* Keep this selector if other styles depend on it, or remove if unused */
				/* white-space: pre-line; */ /* REMOVED: This was causing excessive spacing between elements */
			}
			/* TOC Styles */
			.toc-container {
				margin-top: 2em; /* Add space above TOC */
				padding-top: 1em;
				border-top: 1px solid rgba(var(--black), 0.1); /* Separator line */
				font-size: 0.9em;
			}
			.toc-list,
			.toc-list ul {
				list-style: none;
				padding-left: 0;
				margin: 0;
			}
			.toc-list li {
				margin-bottom: 0.4em;
			}
			.toc-list > li > a {
				font-weight: 600; /* Bolder top-level items */
				text-transform: uppercase;
			}
			.toc-list ul {
				padding-left: 1em; /* Indent sub-items */
				margin-top: 0.4em;
			}
			.toc-list a {
				text-decoration: none;
				color: rgb(var(--subtle-gray)); /* Use subtle gray for TOC links */
			}
			.toc-list a:hover {
				text-decoration: underline;
				color: rgb(var(--black));
			}
			/* Toast for "link copied" feedback */
			.copy-toast {
				position: fixed;
				top: 12px;
				right: 12px;
				background: rgba(0,0,0,0.75);
				color: #fff;
				font-size: 12px;
				padding: 6px 10px;
				border-radius: 6px;
				box-shadow: 0 2px 8px rgba(0,0,0,0.2);
				z-index: 20;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.15s ease;
			}
			.copy-toast.show { opacity: 1; }
		</style>
	</head>

	<body class={`${pageType} ${strictSpacing ? 'strict-spacing' : ''} ${immersive ? 'immersive' : ''}`}>
		<div class="layout-wrapper">
			<aside class="sidebar">
				<Header />
				{toc.length > 0 && (
					<nav class="toc-container" aria-label="Table of Contents">
						<ul class="toc-list">
							{toc.map((heading) => (
								<li>
									<a href={`#${heading.slug}`}>{heading.text}</a>
									{heading.subheadings.length > 0 && (
										<ul>
											{heading.subheadings.map((subheading) => (
												<li>
													<a href={`#${subheading.slug}`}>{subheading.text}</a>
												</li>
											))}
										</ul>
									)}
								</li>
							))}
						</ul>
					</nav>
				)}
			</aside>
			<div class="main-content-area">
				<main>
					<button id="toggle-compact" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 10; font-size: 0.75rem; padding: 0.4rem 0.6rem; background: rgba(255,255,255,0.8); border: 1px solid #eee; border-radius: 4px; color: #666; box-shadow: 0 1px 3px rgba(0,0,0,0.1); opacity: 0.3; transition: opacity 0.2s">Aa</button>
					<article>
						<div class="prose">
							{(pageType === 'literature2' || pageType === 'literature3') && (
								<a href="/" class="back-to-blog">« Back to blog</a>
							)}
							{/*
							<div class="post-header">
								<h1 class="post-title">{title}</h1>
								<div class="post-meta">
									<FormattedDate date={pubDate} />
									{updatedDate && (
										<span class="last-updated-on">
											(updated <FormattedDate date={updatedDate} />)
										</span>
									)}
								</div>
								{tags && tags.length > 0 && (
									<ul class="tags-list" aria-label="Tags">
										<li>tags:</li>
										{tags.map((tag) => (
											<li>
												<a href={`/tags/${tag}`}>{tag}</a>
											</li>
										))}
									</ul>
								)}
							</div>
							*/}
							{/* Removed hero image rendering as it was inside post-header */}
							<section>
								<slot />
							</section>
						</div>
					</article>
				</main>
				<Footer />
			</div>
            {/* Add empty sidenotes area */}
            <aside class="sidenotes-area">
                {/* TODO: Render actual sidenotes here */}
            </aside>
		</div>
		<progress class="reading" max="100" value="0" style="display:none"></progress>
		<script type="module" client:load>
			// Add hover effect for button
			const btn = document.getElementById('toggle-compact');
			if (btn) {
				btn.addEventListener('mouseover', () => btn.style.opacity = '1');
				btn.addEventListener('mouseout', () => btn.style.opacity = '0.3');
			}
			const key = 'reader:compact';
			const body = document.body;
			if (localStorage.getItem(key)) body.classList.add('compact');
			document.getElementById('toggle-compact')?.addEventListener('click', () => {
				body.classList.toggle('compact');
				if (body.classList.contains('compact')) localStorage.setItem(key, '1');
				else localStorage.removeItem(key);
			});
const bodyCls=document.body.classList; if(bodyCls.contains('stanza')){const prog=document.querySelector('progress.reading'); if(prog){prog.style.display='block'; window.addEventListener('scroll',()=>{const h=document.documentElement; const percent=h.scrollTop/(h.scrollHeight-h.clientHeight); prog.value=percent*100;});}
			document.querySelectorAll('.prose p').forEach(p=>{if(p.textContent.trim().length<60)p.classList.add('stanza');});}
		</script>
		{(pageType === 'literature' || pageType === 'literature2' || pageType === 'literature3') && (
			<script type="module">
				// Track active heading based on scroll position
				const headings = document.querySelectorAll('.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6');
				
				// Add click handlers to headings for hash navigation
				headings.forEach(heading => {
					heading.style.cursor = 'pointer';
					heading.title = 'Click to jump • Alt-click to copy link';
					heading.addEventListener('click', async (e) => {
						e.preventDefault();
						const id = heading.id;
						if (e.altKey && id) {
							const url = location.origin + location.pathname + '#' + id;
							try { await navigator.clipboard.writeText(url); showCopyToast(heading); } catch {}
							return;
						}
						// Calculate position with offset for better spacing
						const headingTop = heading.offsetTop;
						const offset = 20; // Space above heading
						const scrollTo = headingTop - offset;
						window.scrollTo({ top: scrollTo, behavior: 'smooth' });
						if (id) { history.pushState(null, null, '#' + id); }
					});
				});

				function showCopyToast() {
					const toast = document.createElement('div');
					toast.textContent = 'Link copied';
					toast.className = 'copy-toast show';
					document.body.appendChild(toast);
					setTimeout(()=> toast.classList.remove('show'), 1000);
					setTimeout(()=> toast.remove(), 1300);
				}
				
				function updateActiveHeading() {
					const scrollPosition = window.scrollY + 100; // Add offset for better UX
					let activeHeading = null;
					
					// Find the heading that's currently in view
					for (let i = headings.length - 1; i >= 0; i--) {
						const heading = headings[i];
						const headingTop = heading.offsetTop;
						
						if (scrollPosition >= headingTop) {
							activeHeading = heading;
							break;
						}
					}
					
					// Remove active class from all headings
					headings.forEach(h => h.classList.remove('active-heading'));
					
					// Add active class to current heading
					if (activeHeading) {
						activeHeading.classList.add('active-heading');
					}
				}
				
				// Update on scroll with throttling
				let scrollTimer;
				window.addEventListener('scroll', () => {
					if (scrollTimer) return;
					scrollTimer = setTimeout(() => {
						scrollTimer = null;
						updateActiveHeading();
					}, 50);
				});
				
				// Update on load
				updateActiveHeading();

				// Save & restore reading position for literature pages
				if (document.body.classList.contains('literature')) {
					const key = 'readpos:' + location.pathname;
					let saveTimer;
					window.addEventListener('scroll', () => {
						if (saveTimer) return;
						saveTimer = setTimeout(() => {
							saveTimer = null;
							localStorage.setItem(key, String(window.scrollY));
						}, 200);
					});

					const saved = Number(localStorage.getItem(key) || 0);
					if (saved > 0 && window.scrollY < 10) {
						// Automatically restore without any UI
						window.scrollTo({ top: saved - 20, behavior: 'auto' });
					}
				}
			</script>
		)}
		{pageType === 'literature' && <StyleEditor />}
	</body>
</html>
